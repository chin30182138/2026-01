<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»™äººæŒ‡è·¯ - V33.0 å°ˆæ¥­æ—ºè¡°é‹ç®—ç‰ˆ</title>
    <style>
        :root {
            --gold: #d4af37; 
            --bg-dark: #1a1a1a;
            --panel: #2d2d2d;
            --border: #444;
            --text: #e0e0e0;
            --card-print-bg: #fdfbf7; 
            /* æ—ºè¡°é¡è‰²å®šç¾© */
            --st-strong: #e74c3c; /* å¼· - ç´…è‰² */
            --st-mid: #f39c12;    /* å¹³ - æ©˜è‰² */
            --st-weak: #3498db;   /* å¼± - è—è‰² */
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 1200px; position: relative; }

        /* Header */
        .header {
            text-align: center; border-bottom: 2px solid var(--gold); padding-bottom: 20px; margin-bottom: 20px; position: relative;
        }
        .header h1 { color: var(--gold); margin: 0; letter-spacing: 2px; }

        .settings-btn { position: absolute; top: 0; right: 0; font-size: 24px; cursor: pointer; color: #666; transition: 0.3s; z-index: 100; }
        .settings-btn:hover { color: var(--gold); transform: rotate(90deg); }

        /* Settings Panel */
        #settings-panel {
            display: none; background: #222; border: 1px solid var(--gold); padding: 20px; border-radius: 8px; margin-bottom: 20px;
        }
        .api-input, textarea.custom-prompt { width: 100%; background: #000; border: 1px solid #444; color: #0f0; border-radius: 4px; padding: 10px; box-sizing: border-box; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 50px; height: 30px; padding: 0; background: none; cursor: pointer; vertical-align: middle; }

        /* Layout */
        .control-box {
            background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 20px;
        }
        .row-time { display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 15px; align-items: end; }
        .ganzhi-display { 
            background: #000; color: var(--gold); padding: 10px; border-radius: 4px; border: 1px solid #555; 
            text-align: center; font-weight: bold; font-size: 18px; height: 42px; display: flex; align-items: center; justify-content: center; letter-spacing: 1px;
        }
        .row-hex { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: end; }
        .row-target { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; }
        
        .row-story {
            border-top: 1px dashed #555;
            padding-top: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .story-options { display: flex; gap: 15px; }
        .chk-story-label { 
            cursor: pointer; display: flex; align-items: center; gap: 5px; color: #fff; font-size: 15px; 
            padding: 5px 10px; border: 1px solid #444; border-radius: 15px; transition: 0.3s;
        }
        .chk-story-label:hover { border-color: var(--gold); background: #333; }
        .chk-story-label input { accent-color: var(--gold); transform: scale(1.2); }

        label { color: var(--gold); font-size: 13px; font-weight: bold; display: block; margin-bottom: 5px; }
        select, input[type="date"] { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box; font-size: 14px; height: 42px; }

        .btn-random { width: 100%; height: 42px; background: #3498db; border: none; font-weight: bold; cursor: pointer; color: #fff; border-radius: 4px; }
        .btn-random:hover { background: #2980b9; }

        .moving-zone { background: #222; padding: 10px; border-radius: 4px; border: 1px dashed #555; display: flex; justify-content: space-around; align-items: center; height: 42px; box-sizing: border-box;}
        .chk-label { cursor: pointer; display: flex; align-items: center; gap: 5px; color: #ccc; font-size: 13px; }
        .chk-label input { accent-color: var(--gold); }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-run { flex: 2; padding: 15px; background: linear-gradient(to right, #b8860b, #d4af37); border: none; font-weight: bold; font-size: 18px; cursor: pointer; color: #000; border-radius: 5px; }
        .btn-print { flex: 1; padding: 15px; background: #fff; border: none; font-weight: bold; font-size: 18px; cursor: pointer; color: #000; border-radius: 5px; }

        /* --- Card UI --- */
        #result-box { display: none; margin-top: 30px; }
        .report-header-print { display: none; } 

        .card {
            background: #252525; border: 1px solid var(--gold); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .card-header { font-size: 20px; color: var(--gold); border-bottom: 1px dashed #555; padding-bottom: 12px; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px; }

        /* Table Styling */
        .hex-table { width: 100%; border-collapse: collapse; font-size: 15px; }
        .hex-table th { border-bottom: 2px solid var(--gold); color: var(--gold); padding: 12px 5px; }
        .hex-table td { border-bottom: 1px solid #444; padding: 10px 5px; text-align: center; vertical-align: middle; color: #eee; }

        /* Graph Alignment */
        .yao-graph-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; }
        .yao-bar-container { width: 50px; height: 18px; display: flex; justify-content: center; }
        .move-symbol-container { width: 20px; text-align: left; font-weight: bold; font-size: 18px; color: #ff3333; line-height: 18px; }

        .bar-yang { width: 100%; height: 100%; background: var(--gold); border-radius: 2px; }
        .bar-yin { width: 100%; height: 100%; display: flex; justify-content: space-between; }
        .bar-yin span { width: 42%; height: 100%; background: var(--gold); border-radius: 2px; }

        .tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: #fff; display: inline-block; font-weight: bold; }
        .t-yong { background: #27ae60; } .t-yuan { background: #2980b9; } .t-ji { background: #c0392b; } .t-chou { background: #8e44ad; } .t-xian { background: #555; color: #ccc; border: 1px solid #777; }

        /* äº”è¡Œæ–‡å­— */
        .ganzhi-txt { font-size: 0.9em; font-weight: 800; color: #f1c40f; }

        /* æ—ºè¡°ç‹€æ…‹æ¨™ç±¤ */
        .status-tag { font-size: 12px; font-weight: bold; padding: 2px 4px; border-radius: 3px; margin-left: 5px; }
        .st-strong { color: var(--st-strong); border: 1px solid var(--st-strong); }
        .st-mid { color: var(--st-mid); border: 1px solid var(--st-mid); }
        .st-weak { color: var(--st-weak); border: 1px solid var(--st-weak); }

        /* AI Text */
        #ai-response-container { color: #e0e0e0; line-height: 1.8; white-space: pre-wrap; font-size: 16px; text-align: justify; }
        .ai-loading { color: var(--gold); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* --- ğŸ–¨ï¸ Print Optimization --- */
        @media print {
            body { background-color: #fff; color: #000; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container { max-width: 100%; width: 100%; padding: 20px; }
            .header, .settings-btn, #settings-panel, .control-box, .btn-group { display: none !important; }
            #result-box { display: block !important; margin-top: 0; }
            
            .report-header-print { display: block; text-align: center; margin-bottom: 20px; border-bottom: 3px double #d4af37; padding-bottom: 15px; }
            .report-header-print h1 { font-size: 26pt; margin: 0; color: #000; font-family: "æ¨™æ¥·é«”", serif; }
            
            .card {
                background-color: var(--card-print-bg) !important;
                border: none !important; 
                box-shadow: none;
                margin-bottom: 30px;
                color: #000;
                border-bottom: 1px solid #ccc !important;
                padding-bottom: 20px;
            }
            .card-header { color: #000; border-bottom: 2px solid #000; border-top: 2px solid #000; padding-top: 10px; background-color: #f4f4f4 !important; }
            p, h3, h4 { page-break-inside: avoid; orphans: 3; widows: 3; }
            .hex-table th { color: #000; border-color: #000; }
            .hex-table td { color: #000; border-color: #999; }
            .ganzhi-txt { color: #000 !important; }
            .bar-yang, .bar-yin span { background-color: #000 !important; }
            .tag { border: 1px solid #000; color: #000; background-color: #fff !important; }
            .t-yong { background-color: #ddd !important; }
            #ai-response-container { color: #000; font-size: 13pt; text-align: justify; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="font-size: 40px; margin-bottom: 10px;">â˜¯ï¸</div>
        <h1>ä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼</h1>
        <p>V33.0 å°ˆæ¥­æ—ºè¡°é‹ç®—ç‰ˆ</p>
        <div class="settings-btn" onclick="toggleSettings()" title="è¨­å®š">âš™ï¸</div>
    </div>

    <div id="settings-panel">
        <label style="color:#fff;">ğŸ”‘ OpenAI API Key</label>
        <input type="password" id="apiKey" class="api-input" placeholder="sk-..." onchange="saveSettings()">
        <br><br>
        <label style="color:#fff;">ğŸ¨ åˆ—å°å¡ç‰‡åº•è‰²</label>
        <div style="display:flex; align-items:center; gap:10px;">
            <input type="color" id="printColor" value="#fdfbf7" onchange="updatePrintColor()">
            <span style="color:#aaa; font-size:14px;">(é»æ“Šæ›´æ›é¡è‰²)</span>
        </div>
        <br>
        <label style="color:#fff;">ğŸ“ è‡ªå®šç¾©åˆ†ææç¤ºè©</label>
        <textarea id="customPrompt" class="custom-prompt" placeholder="è¼¸å…¥æ‚¨çš„ç¨é–€å¿ƒæ³•..." onchange="saveSettings()"></textarea>
    </div>

    <div class="control-box">
        <div class="row-time">
            <div><label>ğŸ“… å åœæ—¥æœŸ</label><input type="date" id="dateIn" onchange="calcFullGanzhi()"></div>
            <div><label>ğŸŒ‘ æœˆä»¤</label><select id="monthIn" onchange="calcFullGanzhi()"><option value="å¯…">å¯…æœˆ</option><option value="å¯">å¯æœˆ</option><option value="è¾°">è¾°æœˆ</option><option value="å·³">å·³æœˆ</option><option value="åˆ">åˆæœˆ</option><option value="æœª">æœªæœˆ</option><option value="ç”³">ç”³æœˆ</option><option value="é…‰">é…‰æœˆ</option><option value="æˆŒ">æˆŒæœˆ</option><option value="äº¥">äº¥æœˆ</option><option value="å­">å­æœˆ</option><option value="ä¸‘">ä¸‘æœˆ</option></select></div>
            <div><label>ğŸ•°ï¸ æ™‚è¾°</label><select id="hourIn" onchange="calcFullGanzhi()"><option value="å­">å­æ™‚</option><option value="ä¸‘">ä¸‘æ™‚</option><option value="å¯…">å¯…æ™‚</option><option value="å¯">å¯æ™‚</option><option value="è¾°">è¾°æ™‚</option><option value="å·³">å·³æ™‚</option><option value="åˆ">åˆæ™‚</option><option value="æœª">æœªæ™‚</option><option value="ç”³">ç”³æ™‚</option><option value="é…‰">é…‰æ™‚</option><option value="æˆŒ">æˆŒæ™‚</option><option value="äº¥">äº¥æ™‚</option></select></div>
        </div>
        <div style="background:#222; padding:5px; border-radius:4px; margin-top:-10px;"><div id="ganzhi-display" class="ganzhi-display">è«‹é¸æ“‡æ—¥æœŸ...</div></div>
        <div class="row-hex">
            <div><label>â¬†ï¸ ä¸Šå¦</label><select id="upGua"><option value="1">1. ä¹¾</option><option value="2">2. å…Œ</option><option value="3">3. é›¢</option><option value="4">4. éœ‡</option><option value="5">5. å·½</option><option value="6">6. å</option><option value="7">7. è‰®</option><option value="8">8. å¤</option></select></div>
            <div><label>â¬‡ï¸ ä¸‹å¦</label><select id="lowGua"><option value="1">1. ä¹¾</option><option value="2">2. å…Œ</option><option value="3">3. é›¢</option><option value="4">4. éœ‡</option><option value="5">5. å·½</option><option value="6">6. å</option><option value="7">7. è‰®</option><option value="8">8. å¤</option></select></div>
            <div><label>ğŸ² è‡ªå‹•èµ·å¦</label><button class="btn-random" onclick="randomHex()">é›»è…¦æ–å¦</button></div>
        </div>
        <div class="row-target">
            <div><label>ğŸ¯ ç”¨ç¥</label><select id="useGod"><option value="ä¸–çˆ»">ä¸–çˆ» (è‡ªå·±)</option><option value="æ‡‰çˆ»">æ‡‰çˆ» (å°æ–¹)</option><option value="å¦»è²¡">å¦»è²¡</option><option value="å®˜é¬¼">å®˜é¬¼</option><option value="çˆ¶æ¯">çˆ¶æ¯</option><option value="å­å­«">å­å­«</option><option value="å…„å¼Ÿ">å…„å¼Ÿ</option></select></div>
            <div>
                <label>âš¡ å‹•çˆ»</label>
                <div class="moving-zone">
                    <label class="chk-label"><input type="checkbox" id="move1"> åˆ</label><label class="chk-label"><input type="checkbox" id="move2"> äºŒ</label><label class="chk-label"><input type="checkbox" id="move3"> ä¸‰</label><label class="chk-label"><input type="checkbox" id="move4"> å››</label><label class="chk-label"><input type="checkbox" id="move5"> äº”</label><label class="chk-label"><input type="checkbox" id="move6"> ä¸Š</label>
                </div>
            </div>
        </div>
        <div class="row-story">
            <label>ğŸ“– å‘½é‹åŠ‡å ´è¨­å®š (å¯è¤‡é¸)</label>
            <div class="story-options">
                <label class="chk-story-label"><input type="checkbox" id="checkLove" value="love"> ğŸ’– æ„Ÿæƒ…</label>
                <label class="chk-story-label"><input type="checkbox" id="checkHealth" value="health"> ğŸŒ¿ å¥åº·</label>
                <label class="chk-story-label"><input type="checkbox" id="checkWealth" value="wealth"> ğŸ’° æŠ•è³‡</label>
            </div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-run" onclick="analyzeAndCallAI()">ğŸš€ å•Ÿå‹•æ’ç›¤ + ç”Ÿæˆæ•…äº‹</button>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±å‘Š</button>
    </div>

    <div id="result-box">
        <div class="report-header-print">
            <div style="font-size: 40px;">ğŸ¢</div>
            <h1>ä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼åˆ†æå ±å‘Š</h1>
            <p>Immortal Guidance Beast Analysis</p>
        </div>

        <div class="card">
            <div class="card-header">
                <span>1. å¤©å‚è±¡ (å¦è±¡çµæ§‹)</span>
                <span id="hex-title-small" style="font-size:16px;"></span>
            </div>
            <div id="card-ganzhi" style="text-align:center; margin-bottom:15px; font-weight:bold; color:#888;"></div>
            <table class="hex-table">
                <thead>
                    <tr>
                        <th width="10%">ä¼ç¥</th>
                        <th width="10%">å…­ç¸</th>
                        <th width="20%">é£›ç¥(å…­è¦ª)</th>
                        <th width="15%">å¦è±¡</th>
                        <th width="8%">ä¸–æ‡‰</th>
                        <th width="20%">è®Šå¦</th>
                        <th>ç¥ç…(æ—ºè¡°)</th>
                    </tr>
                </thead>
                <tbody id="resBody"></tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-header"><span>2. éˆé­‚è§£ç¢¼ (æ¦®æ ¼ x äº”è¡Œ x å‘½é‹åŠ‡å ´)</span><span>ğŸ”® AI Analysis</span></div>
            <div id="ai-response-container">è«‹è¼¸å…¥ API Key ä¸¦é»æ“Šå•Ÿå‹•ï¼ŒAI å°‡ç‚ºæ‚¨è§£è®€...</div>
        </div>
        <textarea id="aiPrompt" style="display:none;"></textarea>
    </div>
</div>

<script>
    // --- Data ---
    const stems = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
    const branches = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
    const wxMap = {"å­":"æ°´","ä¸‘":"åœŸ","å¯…":"æœ¨","å¯":"æœ¨","è¾°":"åœŸ","å·³":"ç«","åˆ":"ç«","æœª":"åœŸ","ç”³":"é‡‘","é…‰":"é‡‘","æˆŒ":"åœŸ","äº¥":"æ°´"};
    const beasts = ["é’é¾","æœ±é›€","å‹¾é™³","è£è›‡","ç™½è™","ç„æ­¦"];
    const beastPsych = { 
        "é’é¾": "ä»æ…ˆ/æ“´å¼µ/æ–°çš„é–‹å§‹", 
        "æœ±é›€": "è¡¨é”/ç„¦æ…®/å£èˆŒæ–‡æ›¸", 
        "å‹¾é™³": "å›ºåŸ·/ç©©å®š/ç”°ç”¢è€èˆŠ", 
        "è£è›‡": "ä¸å®‰/ç³¾çµ/æ€ªç•°å¤šç–‘", 
        "ç™½è™": "å‰µå‚·/è¡Œå‹•/è¡€å…‰/æ€¥è¿«", 
        "ç„æ­¦": "éš±å¯†/æ…¾æœ›/æ›–æ˜§/é¨™å±€" 
    };
    
    // ğŸ”¥ äº”è¡Œç”Ÿå‰‹çŸ©é™£ [ç”Ÿæˆ‘, æˆ‘ç”Ÿ, å‰‹æˆ‘, æˆ‘å‰‹, åŒæˆ‘]
    const wuxingRels = {
        "é‡‘": {sheng:"åœŸ", xie:"æ°´", ke:"ç«", keBy:"æœ¨", same:"é‡‘"},
        "æœ¨": {sheng:"æ°´", xie:"ç«", ke:"é‡‘", keBy:"åœŸ", same:"æœ¨"},
        "æ°´": {sheng:"é‡‘", xie:"æœ¨", ke:"åœŸ", keBy:"ç«", same:"æ°´"},
        "ç«": {sheng:"æœ¨", xie:"åœŸ", ke:"æ°´", keBy:"é‡‘", same:"ç«"},
        "åœŸ": {sheng:"ç«", xie:"é‡‘", ke:"æœ¨", keBy:"æ°´", same:"åœŸ"}
    };
    const clashesMap = {"å­":"åˆ","åˆ":"å­","ä¸‘":"æœª","æœª":"ä¸‘","å¯…":"ç”³","ç”³":"å¯…","å¯":"é…‰","é…‰":"å¯","è¾°":"æˆŒ","æˆŒ":"è¾°","å·³":"äº¥","äº¥":"å·³"};

    let gYear="", gMonth="", gDay="", gHour="", gDayGan="", gKw=[];

    // --- Init ---
    window.addEventListener('load', function() {
        if(localStorage.getItem("openai_key")) document.getElementById('apiKey').value = localStorage.getItem("openai_key");
        if(localStorage.getItem("custom_prompt")) document.getElementById('customPrompt').value = localStorage.getItem("custom_prompt");
        const savedColor = localStorage.getItem("print_color");
        if(savedColor) {
            document.getElementById('printColor').value = savedColor;
            document.documentElement.style.setProperty('--card-print-bg', savedColor);
        }
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('dateIn').value = `${yyyy}-${mm}-${dd}`;
        const h = today.getHours();
        const hIdx = Math.floor((h + 1) / 2) % 12;
        document.getElementById('hourIn').value = branches[hIdx];
        document.getElementById('monthIn').value = branches[(today.getMonth()+2)%12];
        calcFullGanzhi();
    });

    function toggleSettings() { const p = document.getElementById('settings-panel'); p.style.display = p.style.display==='block'?'none':'block'; }
    function saveSettings() {
        localStorage.setItem("openai_key", document.getElementById('apiKey').value);
        localStorage.setItem("custom_prompt", document.getElementById('customPrompt').value);
    }
    function updatePrintColor() {
        const c = document.getElementById('printColor').value;
        document.documentElement.style.setProperty('--card-print-bg', c);
        localStorage.setItem("print_color", c);
    }

    function calcFullGanzhi() {
        const dVal = document.getElementById('dateIn').value; if(!dVal) return;
        const date = new Date(dVal);
        const yOffset = date.getFullYear() - 1984;
        let yIdx = yOffset % 60; if(yIdx<0) yIdx+=60;
        gYear = stems[yIdx%10] + branches[yIdx%12];

        const mZhi = document.getElementById('monthIn').value; 
        const mZhiIdx = branches.indexOf(mZhi);
        const mStart = {0:2, 1:4, 2:6, 3:8, 4:0}[yIdx%10 % 5]; 
        let mGanIdx = (mStart + (mZhiIdx>=2 ? mZhiIdx-2 : mZhiIdx+10)) % 10; 
        gMonth = stems[mGanIdx] + mZhi;

        const base = new Date("2000-01-01"); 
        const diffDays = Math.floor((date.getTime() - base.getTime()) / (1000 * 60 * 60 * 24));
        let dIdx = (54 + diffDays) % 60; if(dIdx<0) dIdx+=60;
        gDayGan = stems[dIdx%10]; gDay = gDayGan + branches[dIdx%12];
        const step = 9 - (dIdx%10);
        gKw = [branches[(dIdx%12+step+1)%12], branches[(dIdx%12+step+2)%12]];

        const hZhi = document.getElementById('hourIn').value;
        const hZhiIdx = branches.indexOf(hZhi);
        const hStart = {0:0, 1:2, 2:4, 3:6, 4:8}[dIdx%10 % 5];
        gHour = stems[(hStart+hZhiIdx)%10] + hZhi;

        document.getElementById('ganzhi-display').innerText = `${gYear}å¹´ ${gMonth}æœˆ ${gDay}æ—¥ ${gHour}æ™‚ (ç©ºäº¡:${gKw.join('')})`;
    }

    function randomHex() {
        document.getElementById('upGua').value = Math.floor(Math.random()*8)+1;
        document.getElementById('lowGua').value = Math.floor(Math.random()*8)+1;
        for(let i=1; i<=6; i++) document.getElementById(`move${i}`).checked = (Math.random()<0.2);
        analyzeAndCallAI();
    }

    // --- Core Logic ---
    const hexMap = {
        "1-1":{n:"ä¹¾ç‚ºå¤©",g:"é‡‘",pid:1,s:6}, "1-5":{n:"å¤©é¢¨å§¤",g:"é‡‘",pid:1,s:1}, "1-7":{n:"å¤©å±±é¯",g:"é‡‘",pid:1,s:2}, "1-8":{n:"å¤©åœ°å¦",g:"é‡‘",pid:1,s:3}, "5-8":{n:"é¢¨åœ°è§€",g:"é‡‘",pid:1,s:4}, "7-8":{n:"å±±åœ°å‰",g:"é‡‘",pid:1,s:5}, "3-8":{n:"ç«åœ°æ™‰",g:"é‡‘",pid:1,s:4}, "3-1":{n:"ç«å¤©å¤§æœ‰",g:"é‡‘",pid:1,s:3},
        "2-2":{n:"å…Œç‚ºæ¾¤",g:"é‡‘",pid:2,s:6}, "2-6":{n:"æ¾¤æ°´å›°",g:"é‡‘",pid:2,s:1}, "2-8":{n:"æ¾¤åœ°èƒ",g:"é‡‘",pid:2,s:2}, "2-7":{n:"æ¾¤å±±å’¸",g:"é‡‘",pid:2,s:3}, "6-7":{n:"æ°´å±±è¹‡",g:"é‡‘",pid:2,s:4}, "8-7":{n:"åœ°å±±è¬™",g:"é‡‘",pid:2,s:5}, "4-7":{n:"é›·å±±å°é",g:"é‡‘",pid:2,s:4}, "4-2":{n:"é›·æ¾¤æ­¸å¦¹",g:"é‡‘",pid:2,s:3},
        "3-3":{n:"é›¢ç‚ºç«",g:"ç«",pid:3,s:6}, "3-7":{n:"ç«å±±æ—…",g:"ç«",pid:3,s:1}, "3-5":{n:"ç«é¢¨é¼",g:"ç«",pid:3,s:2}, "3-6":{n:"ç«æ°´æœªæ¿Ÿ",g:"ç«",pid:3,s:3}, "7-6":{n:"å±±æ°´è’™",g:"ç«",pid:3,s:4}, "5-6":{n:"é¢¨æ°´æ¸™",g:"ç«",pid:3,s:5}, "1-6":{n:"å¤©æ°´è¨Ÿ",g:"ç«",pid:3,s:4}, "1-3":{n:"å¤©ç«åŒäºº",g:"ç«",pid:3,s:3},
        "4-4":{n:"éœ‡ç‚ºé›·",g:"æœ¨",pid:4,s:6}, "4-8":{n:"é›·åœ°è±«",g:"æœ¨",pid:4,s:1}, "4-6":{n:"é›·æ°´è§£",g:"æœ¨",pid:4,s:2}, "4-5":{n:"é›·é¢¨æ†",g:"æœ¨",pid:4,s:3}, "8-5":{n:"åœ°é¢¨å‡",g:"æœ¨",pid:4,s:4}, "6-5":{n:"æ°´é¢¨äº•",g:"æœ¨",pid:4,s:5}, "2-5":{n:"æ¾¤é¢¨å¤§é",g:"æœ¨",pid:4,s:4}, "2-4":{n:"æ¾¤é›·éš¨",g:"æœ¨",pid:4,s:3},
        "5-5":{n:"å·½ç‚ºé¢¨",g:"æœ¨",pid:5,s:6}, "5-1":{n:"é¢¨å¤©å°ç•œ",g:"æœ¨",pid:5,s:1}, "5-3":{n:"é¢¨ç«å®¶äºº",g:"æœ¨",pid:5,s:2}, "5-4":{n:"é¢¨é›·ç›Š",g:"æœ¨",pid:5,s:3}, "1-4":{n:"å¤©é›·ç„¡å¦„",g:"æœ¨",pid:5,s:4}, "3-4":{n:"ç«é›·å™¬å—‘",g:"æœ¨",pid:5,s:5}, "7-4":{n:"å±±é›·é ¤",g:"æœ¨",pid:5,s:4}, "7-5":{n:"å±±é¢¨è ±",g:"æœ¨",pid:5,s:3},
        "6-6":{n:"åç‚ºæ°´",g:"æ°´",pid:6,s:6}, "6-2":{n:"æ°´æ¾¤ç¯€",g:"æ°´",pid:6,s:1}, "6-4":{n:"æ°´é›·å±¯",g:"æ°´",pid:6,s:2}, "6-3":{n:"æ°´ç«æ—¢æ¿Ÿ",g:"æ°´",pid:6,s:3}, "2-3":{n:"æ¾¤ç«é©",g:"æ°´",pid:6,s:4}, "4-3":{n:"é›·ç«è±",g:"æ°´",pid:6,s:5}, "8-3":{n:"åœ°ç«æ˜å¤·",g:"æ°´",pid:6,s:4}, "8-6":{n:"åœ°æ°´å¸«",g:"æ°´",pid:6,s:3},
        "7-7":{n:"è‰®ç‚ºå±±",g:"åœŸ",pid:7,s:6}, "7-3":{n:"å±±ç«è³",g:"åœŸ",pid:7,s:1}, "7-1":{n:"å±±å¤©å¤§ç•œ",g:"åœŸ",pid:7,s:2}, "7-2":{n:"å±±æ¾¤æ",g:"åœŸ",pid:7,s:3}, "3-2":{n:"ç«æ¾¤ç½",g:"åœŸ",pid:7,s:4}, "1-2":{n:"å¤©æ¾¤å±¥",g:"åœŸ",pid:7,s:5}, "5-2":{n:"é¢¨æ¾¤ä¸­å­š",g:"åœŸ",pid:7,s:4}, "5-7":{n:"é¢¨å±±æ¼¸",g:"åœŸ",pid:7,s:3},
        "8-8":{n:"å¤ç‚ºåœ°",g:"åœŸ",pid:8,s:6}, "8-4":{n:"åœ°é›·å¾©",g:"åœŸ",pid:8,s:1}, "8-2":{n:"åœ°æ¾¤è‡¨",g:"åœŸ",pid:8,s:2}, "8-1":{n:"åœ°å¤©æ³°",g:"åœŸ",pid:8,s:3}, "4-1":{n:"é›·å¤©å¤§å£¯",g:"åœŸ",pid:8,s:4}, "2-1":{n:"æ¾¤å¤©å¤¬",g:"åœŸ",pid:8,s:5}, "6-1":{n:"æ°´å¤©éœ€",g:"åœŸ",pid:8,s:4}, "6-8":{n:"æ°´åœ°æ¯”",g:"åœŸ",pid:8,s:3}
    };
    const trigrams = {
        1: {n:"ä¹¾", p:[1,1,1], i:["å­","å¯…","è¾°"], o:["åˆ","ç”³","æˆŒ"]},
        2: {n:"å…Œ", p:[1,1,0], i:["å·³","å¯","ä¸‘"], o:["äº¥","é…‰","æœª"]},
        3: {n:"é›¢", p:[1,0,1], i:["å¯","ä¸‘","äº¥"], o:["é…‰","æœª","å·³"]},
        4: {n:"éœ‡", p:[1,0,0], i:["å­","å¯…","è¾°"], o:["åˆ","ç”³","æˆŒ"]},
        5: {n:"å·½", p:[0,1,1], i:["ä¸‘","äº¥","é…‰"], o:["æœª","å·³","å¯"]},
        6: {n:"å", p:[0,1,0], i:["å¯…","è¾°","åˆ"], o:["ç”³","æˆŒ","å­"]},
        7: {n:"è‰®", p:[0,0,1], i:["è¾°","åˆ","ç”³"], o:["æˆŒ","å­","å¯…"]},
        8: {n:"å¤", p:[0,0,0], i:["æœª","å·³","å¯"], o:["ä¸‘","äº¥","é…‰"]}
    };

    function getRel(targetWx, mainGongWx) {
        if(targetWx===mainGongWx) return "å…„å¼Ÿ";
        const parent={"é‡‘":"åœŸ","æœ¨":"æ°´","æ°´":"é‡‘","ç«":"æœ¨","åœŸ":"ç«"}[mainGongWx];
        if(targetWx===parent) return "çˆ¶æ¯";
        const child={"é‡‘":"æ°´","æœ¨":"ç«","æ°´":"æœ¨","ç«":"åœŸ","åœŸ":"é‡‘"}[mainGongWx];
        if(targetWx===child) return "å­å­«";
        const killer={"é‡‘":"ç«","æœ¨":"é‡‘","æ°´":"åœŸ","ç«":"æ°´","åœŸ":"æœ¨"}[mainGongWx];
        if(targetWx===killer) return "å®˜é¬¼";
        const wealth={"é‡‘":"æœ¨","æœ¨":"åœŸ","æ°´":"ç«","ç«":"é‡‘","åœŸ":"æ°´"}[mainGongWx];
        if(targetWx===wealth) return "å¦»è²¡";
        return "å…„å¼Ÿ";
    }

    function getRole(targetRel, activeUseGod) {
        const logic = {
            "çˆ¶æ¯": {y:"å®˜é¬¼", j:"å¦»è²¡", c:"å­å­«"}, "å…„å¼Ÿ": {y:"çˆ¶æ¯", j:"å®˜é¬¼", c:"å¦»è²¡"},
            "å­å­«": {y:"å…„å¼Ÿ", j:"çˆ¶æ¯", c:"å®˜é¬¼"}, "å¦»è²¡": {y:"å­å­«", j:"å…„å¼Ÿ", c:"çˆ¶æ¯"}, "å®˜é¬¼": {y:"å¦»è²¡", j:"å­å­«", c:"å…„å¼Ÿ"}
        }[activeUseGod];
        if(targetRel===activeUseGod) return "ç”¨ç¥";
        if(targetRel===logic.y) return "å…ƒç¥";
        if(targetRel===logic.j) return "å¿Œç¥";
        if(targetRel===logic.c) return "ä»‡ç¥";
        return "é–’ç¥"; 
    }

    function getRoleBadge(role) {
        if(role==="ç”¨ç¥") return `<span class="tag t-yong">ç”¨</span>`;
        if(role==="å…ƒç¥") return `<span class="tag t-yuan">å…ƒ</span>`;
        if(role==="å¿Œç¥") return `<span class="tag t-ji">å¿Œ</span>`;
        if(role==="ä»‡ç¥") return `<span class="tag t-chou">ä»‡</span>`;
        return `<span class="tag t-xian">é–’</span>`;
    }

    // ğŸ”¥ æ ¸å¿ƒï¼šæ—ºè¡°é‹ç®—å¼•æ“ (V33.0 New)
    function calculateYaoStrength(yaoZhi, yaoWx, mZhi, mWx, dZhi, dWx) {
        let score = 0;
        let desc = "";
        let isMonthBreak = (clashesMap[mZhi] === yaoZhi);
        let isDayBreak = (clashesMap[dZhi] === yaoZhi);
        
        // 1. æœˆä»¤åˆ¤æ–·
        let mRel = "";
        if(yaoWx === mWx) { score += 2; mRel = "æœˆæ—º"; }
        else if(wuxingRels[mWx].sheng === yaoWx) { score += 1; mRel = "æœˆç›¸"; }
        else if(wuxingRels[yaoWx].sheng === mWx) { score += -0.5; mRel = "æœˆä¼‘"; }
        else if(wuxingRels[yaoWx].ke === mWx) { score += -1; mRel = "æœˆå›š"; }
        else { score += -2; mRel = "æœˆæ­»"; } // æœˆå‰‹çˆ»

        // 2. æ—¥è¾°åˆ¤æ–· (åŠ æ¸›åˆ†)
        let dRel = "";
        if(yaoZhi === dZhi) { score += 3; dRel = "æ—¥å»º"; } // æ—¥å»ºæ¥µå¼·
        else if(yaoWx === dWx) { score += 2; dRel = "æ—¥æ‰¶"; } // åŒäº”è¡Œ
        else if(wuxingRels[dWx].sheng === yaoWx) { score += 1.5; dRel = "æ—¥ç”Ÿ"; } // æ—¥ç”Ÿçˆ» (åŠ åˆ†)
        else if(wuxingRels[dWx].ke === yaoWx) { score -= 2; dRel = "æ—¥å‰‹"; } // æ—¥å‰‹çˆ» (æ¸›åˆ†)
        else { dRel = "æ—¥æ´©"; } // å…¶ä»–æƒ…æ³

        // 3. ç¥ç…åˆ¤å®š
        let finalStatus = "";
        let cssClass = "st-mid";

        if(isMonthBreak) {
            finalStatus = "ã€æœˆç ´ã€‘";
            cssClass = "st-weak";
        } else if(isDayBreak && score > 0) {
            finalStatus = "ã€æš—å‹•ã€‘"; // æ—¥æ²–ä½†æ—º
            cssClass = "st-strong";
        } else if(isDayBreak && score <= 0) {
            finalStatus = "ã€æ—¥ç ´ã€‘";
            cssClass = "st-weak";
        } else {
            if(score >= 2) { finalStatus = "ã€æ—ºã€‘"; cssClass = "st-strong"; }
            else if(score <= -1) { finalStatus = "ã€å¼±ã€‘"; cssClass = "st-weak"; }
            else { finalStatus = "ã€å¹³ã€‘"; cssClass = "st-mid"; }
        }

        return { status: finalStatus, desc: `(${mRel}${dRel})`, css: cssClass, rawScore: score };
    }

    async function analyzeAndCallAI() {
        if(!gDayGan) calcFullGanzhi();
        
        const up = parseInt(document.getElementById('upGua').value);
        const low = parseInt(document.getElementById('lowGua').value);
        const selectedUseGod = document.getElementById('useGod').value;
        const monthZhi = document.getElementById('monthIn').value;
        const monthWx = wxMap[monthZhi];
        const dayZhi = gDay.substring(1);
        const dayWx = wxMap[dayZhi];
        
        // Options
        const isLove = document.getElementById('checkLove').checked;
        const isHealth = document.getElementById('checkHealth').checked;
        const isWealth = document.getElementById('checkWealth').checked;
        let storyThemes = [];
        if(isLove) storyThemes.push("æ„Ÿæƒ…"); if(isHealth) storyThemes.push("å¥åº·"); if(isWealth) storyThemes.push("æŠ•è³‡");
        
        const key = `${up}-${low}`;
        const hexInfo = hexMap[key];
        const gongWx = hexInfo.g;
        const pid = hexInfo.pid;
        const shiPos = hexInfo.s;
        const yingPos = shiPos > 3 ? shiPos - 3 : shiPos + 3;

        const lines = [];
        trigrams[low].i.forEach((b,i)=>lines.push({b:b, wx:wxMap[b], t:trigrams[low].p[i], pos:i}));
        trigrams[up].o.forEach((b,i)=>lines.push({b:b, wx:wxMap[b], t:trigrams[up].p[i], pos:i+3}));
        lines.forEach(l => l.rel = getRel(l.wx, gongWx));

        let activeUseGod = selectedUseGod;
        if(selectedUseGod==="ä¸–çˆ»") activeUseGod = lines[shiPos-1].rel;
        else if(selectedUseGod==="æ‡‰çˆ»") activeUseGod = lines[yingPos-1].rel;

        let moveIndices = [];
        for(let i=0; i<6; i++) {
            if(document.getElementById(`move${i+1}`).checked) { moveIndices.push(i); lines[i].isMoving = true; }
        }
        let newUpBits = [...trigrams[up].p];
        let newLowBits = [...trigrams[low].p];
        moveIndices.forEach(idx => {
            if(idx < 3) newLowBits[idx] = newLowBits[idx] === 1 ? 0 : 1;
            else newUpBits[idx-3] = newUpBits[idx-3] === 1 ? 0 : 1;
        });
        function findTrigramID(bits) { for(let k=1; k<=8; k++) if(JSON.stringify(trigrams[k].p) === JSON.stringify(bits)) return k; return 1; }
        const newLowID = findTrigramID(newLowBits);
        const newUpID = findTrigramID(newUpBits);
        const newKey = `${newUpID}-${newLowID}`;
        const newHexInfo = hexMap[newKey] || {n:"(éœå¦)"};
        const bianLines = [];
        trigrams[newLowID].i.forEach((b,i)=>bianLines.push({b:b, wx:wxMap[b]}));
        trigrams[newUpID].o.forEach((b,i)=>bianLines.push({b:b, wx:wxMap[b]}));

        let fushens = {}; 
        const allRels = ["çˆ¶æ¯","å…„å¼Ÿ","å­å­«","å¦»è²¡","å®˜é¬¼"];
        const presentRels = new Set(lines.map(l => l.rel));
        const missing = allRels.filter(r => !presentRels.has(r));
        if (missing.length > 0) {
            const baseLines = [...trigrams[pid].i, ...trigrams[pid].o];
            baseLines.forEach((b, i) => {
                let wx = wxMap[b];
                let r = getRel(wx, gongWx);
                if (missing.includes(r)) {
                    let role = getRole(r, activeUseGod);
                    fushens[i] = {rel:r, b:b, wx:wx, role:role};
                }
            });
        }

        const bStart = {"ç”²":0,"ä¹™":0,"ä¸™":1,"ä¸":1,"æˆŠ":2,"å·±":3,"åºš":4,"è¾›":4,"å£¬":5,"ç™¸":5}[gDayGan] || 0;
        
        document.getElementById('result-box').style.display = 'block';
        document.getElementById('hex-title-small').innerText = `${hexInfo.n} (${gongWx}å®®) ${moveIndices.length>0 ? 'ä¹‹ '+newHexInfo.n : ''}`;
        document.getElementById('card-ganzhi').innerText = document.getElementById('ganzhi-display').innerText;
        
        const tbody = document.getElementById('resBody');
        tbody.innerHTML = "";
        
        let pYong=[], pYuan=[], pJi=[], pChou=[], pXian=[];

        for(let i=5; i>=0; i--) {
            const l = lines[i];
            const beast = beasts[(bStart + i) % 6];
            let role = getRole(l.rel, activeUseGod);
            let roleBadge = getRoleBadge(role);
            let tags = "";
            let isBroken = (l.b === clashesMap[monthZhi]);
            let isVoid = gKw.includes(l.b);
            if(isVoid) tags += `<span class="tag t-void">ç©º</span>`;
            if(i+1 === shiPos) tags += `<span class="tag t-shi">ä¸–</span>`;
            if(i+1 === yingPos) tags += `<span class="tag t-ying">æ‡‰</span>`;

            let moveWxStr = "";
            let barHtml = "", moveSymbol = "";
            
            if(l.isMoving) {
                const bL = bianLines[i];
                moveWxStr = bL.wx;
                barHtml = l.t===1 ? '<div class="bar-yang"></div>' : '<div class="bar-yin"><span></span><span></span></div>';
                moveSymbol = l.t===1 ? '<div class="move-symbol-box">O</div>' : '<div class="move-symbol-box">X</div>';
            } else {
                barHtml = l.t===1 ? '<div class="bar-yang"></div>' : '<div class="bar-yin"><span></span><span></span></div>';
            }

            // ğŸ”¥ èª¿ç”¨æ—ºè¡°è¨ˆç®—
            let stObj = calculateYaoStrength(l.b, l.wx, monthZhi, monthWx, dayZhi, dayWx);
            let strengthText = `<span class="status-tag ${stObj.css}">${stObj.status}</span> <span style="font-size:11px;color:#888;">${stObj.desc}</span>`;

            let context = `å…­è¦ª:${l.rel}, åœ°æ”¯:${l.b}, ç¥ç¸:${beast}, èƒ½é‡:${stObj.status}${stObj.desc}`;
            if(l.isMoving) {
                const bL = bianLines[i];
                const bRel = getRel(bL.wx, gongWx);
                context += `ã€‚å‹•åŒ–[${bRel}${bL.b}(${bL.wx})]ã€‚`;
            }

            if(role === "ç”¨ç¥") pYong.push(context);
            if(role === "å…ƒç¥") pYuan.push(context);
            if(role === "å¿Œç¥") pJi.push(context);
            if(role === "ä»‡ç¥") pChou.push(context);
            if(role === "é–’ç¥") pXian.push(context);

            let fushenCell = "-";
            if (fushens[i]) {
                const f = fushens[i];
                let fBadge = getRoleBadge(f.role);
                fushenCell = `<span class="fushen-txt">ä¼</span>${fBadge}<span class="fushen-god">${f.rel}</span><span class="fushen-txt">${f.b}</span>`;
            }

            let bianHtml = "";
            if(l.isMoving) {
                const bL = bianLines[i];
                const bRel = getRel(bL.wx, gongWx);
                bianHtml = `<span class="change-arrow">â¡</span> <span class="bian-info">${bRel} ${bL.b}(${bL.wx})</span>`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="fushen-cell">${fushenCell}</td>
                <td>${beast}</td>
                <td style="font-weight:bold; text-align:left; padding-left:10px;">${l.rel} <span class="ganzhi-txt">${l.b}(${l.wx})</span></td>
                <td>
                    <div class="yao-graph-wrapper">
                        <div class="yao-bar-container">${barHtml}</div>
                        <div class="move-symbol-container">${moveSymbol}</div>
                    </div>
                </td>
                <td>${i+1===shiPos?'<span class="tag t-shi">ä¸–</span>':(i+1===yingPos?'<span class="tag t-ying">æ‡‰</span>':'')}</td>
                <td style="text-align:left;">${bianHtml}</td>
                <td style="text-align:left;">${strengthText} ${tags}</td>
            `;
            tbody.appendChild(tr);
        }

        let customP = document.getElementById('customPrompt').value;
        let ganzhiStr = document.getElementById('ganzhi-display').innerText;
        
        let p = `ä½ ç¾åœ¨æ˜¯ã€Œä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼ã€çš„ AI å°å¸«ã€‚
è«‹æ³¨æ„ï¼šæˆ‘å·²ç¶“å¹«ä½ ç®—å¥½äº†æ¯ä¸€çˆ»çš„ã€èƒ½é‡æ—ºè¡°ã€‘ï¼ˆå¦‚ï¼šæœˆæ—ºæ—¥æ‰¶ã€æœˆç ´ã€æš—å‹•ï¼‰ï¼Œè«‹å‹™å¿…ä¾æ“šé€™å€‹å®¢è§€æ•¸æ“šé€²è¡Œè§£è®€ï¼Œä¸è¦è‡ªå·±çŒœæ¸¬æ—ºè¡°ã€‚

### 1. æ ¸å¿ƒè³‡è¨Š
- **å•äº‹**ï¼š${selectedUseGod}ã€‚å¯¦éš›ç”¨ç¥ç‚º **[${activeUseGod}]**ã€‚
- **æ™‚ç©º**ï¼š${ganzhiStr}ã€‚
- **å¦è±¡**ï¼š${hexInfo.n} (äº”è¡Œå±¬${gongWx})ã€‚

### 2. éˆé­‚è§’è‰²åˆ†æ (è«‹çµåˆèƒ½é‡æ—ºè¡°é€²è¡Œè§£è®€)
**(1) ç”¨ç¥ - é¡¯åŒ–é¢å…· (Persona)**
   *ç‹€æ…‹*ï¼š${pYong.length>0 ? pYong.join('ï¼›') : 'ç”¨ç¥ä¼è—'}ã€‚
   *è§£æ*ï¼šæ¡ˆä¸»ç›®å‰çš„èƒ½é‡ç‹€æ…‹å¼·å¼±ï¼Ÿæ˜¯å¦æœ‰åŠ›ï¼Ÿ

**(2) å…ƒç¥ - å…§åœ¨è‡ªæ€§ (Self)**
   *ç‹€æ…‹*ï¼š${pYuan.length>0 ? pYuan.join('ï¼›') : 'å…ƒç¥ä¸ç¾'}ã€‚
   *è§£æ*ï¼šå…§åœ¨è³‡æºæ˜¯å¦å……è¶³ï¼ˆæ—ºç›¸ï¼‰æˆ–åŒ±ä¹ï¼ˆä¼‘å›šï¼‰ï¼Ÿ

**(3) å¿Œç¥ - é™°å½±èˆ‡ææ‡¼ (Shadow)**
   *ç‹€æ…‹*ï¼š${pJi.length>0 ? pJi.join('ï¼›') : 'å¿Œç¥å®‰éœ'}ã€‚
   *è§£æ*ï¼šé™°å½±çš„åŠ›é‡æ˜¯å¦å¼·å¤§ï¼Ÿå¦‚æœæ˜¯ã€Œæš—å‹•ã€ï¼Œä»£è¡¨æ½›æ„è­˜çš„å¹²æ“¾æ­£åœ¨ç™¼ç”Ÿã€‚

**(4) ä»‡ç¥ - å…§åœ¨æ‰¹åˆ¤ (Complex)**
   *ç‹€æ…‹*ï¼š${pChou.length>0 ? pChou.join('ï¼›') : 'ä»‡ç¥å®‰éœ'}ã€‚
   *è§£æ*ï¼šå…§åœ¨çš„æ‰¹åˆ¤è²éŸ³ã€‚

**(5) é–’ç¥ - èƒ½é‡è€—æ**
   *ç‹€æ…‹*ï¼š${pXian.length>0 ? pXian.join('ï¼›') : 'ç„¡'}ã€‚

### 3. ã€ğŸ”® å‘½é‹åŠ‡å ´ï¼šç¥ç¸çš„æ—¥å¸¸æŠ‰æ“‡ã€‘
**æ•…äº‹è¨­å®š**ï¼š${storyThemes.length > 0 ? storyThemes.join(" + ") : "æ—¥å¸¸æŠ‰æ“‡"}ã€‚
**è¦æ±‚**ï¼šçµåˆå…­ç¸æ€§æ ¼èˆ‡ä¸Šè¿°æ—ºè¡°èƒ½é‡ï¼Œæè¿°æ¡ˆä¸»åœ¨å£“åŠ›ä¸‹çš„åæ‡‰ã€‚è‹¥ç”¨ç¥æ—ºï¼Œæè¿°å…¶è‡ªä¿¡ï¼›è‹¥ç”¨ç¥å¼±ï¼Œæè¿°å…¶é€€ç¸®ã€‚

### 4. ç¶œåˆå»ºè­°
${customP ? 'ä½¿ç”¨è€…è£œå……ï¼š'+customP : ''}
è«‹çµ¦å‡ºä¸€æ®µç¸½çµæ€§çš„éˆæ€§æŒ‡å¼•ã€‚`;

        document.getElementById('aiPrompt').value = p;
        await callOpenAI(p);
    }

    async function callOpenAI(prompt) {
        const apiKey = document.getElementById('apiKey').value;
        const resultDiv = document.getElementById('ai-response-container');
        
        if (!apiKey) {
            resultDiv.innerHTML = "<span style='color:#f39c12'>âš ï¸ è«‹é»æ“Šå³ä¸Šè§’é½’è¼ªè¨­å®š API Keyï¼Œæ–¹å¯å•Ÿå‹•éˆé­‚åˆ†æã€‚</span>";
            return;
        }

        resultDiv.innerHTML = `<span class="ai-loading">ğŸ”® ä»™äººæŒ‡è·¯ AI æ­£åœ¨é€£çµéˆé­‚æª”æ¡ˆ... è«‹ç¨å€™...</span>`;

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: "gpt-4", messages: [{ role: "user", content: prompt }], temperature: 0.7 })
            });
            const data = await response.json();
            if (data.error) { resultDiv.innerText = "API éŒ¯èª¤: " + data.error.message; }
            else { resultDiv.innerText = data.choices[0].message.content; }
        } catch (error) { resultDiv.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Keyã€‚"; }
    }
</script>

</body>
</html>
